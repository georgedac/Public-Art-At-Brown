<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Public Art at Brown</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="admin-style.css">
  <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
</head>
<body>
  <div id="sidebar">
    <h1>Public Art <br />@<br /> Brown<br />(Admin)</h1>
    <ul id="menu">
      <li><a href="/">Map</a></li>
      <li><a href="/list">List</a></li>
      <li><a>About</a></li>
      <li class="active"><a href="/admin">Admin</a></li>
    </ul>
  </div>
  <div id="main">
    <div id="map">
    </div>
    <div class="searchWrapper">
      <input id="mainSearch" type="text" placeholder="Search names, artists, addresses...">
      <img src="images/search.png" />
    </div>
    <p>The searchbar, filter box, and map will go here!</p>
    <p>I know the design is horrible, I'm trying my best to make it look more professional!</p>
    <p>To do:</p>
    <ol>
      <li>Change font for title so it looks better</li>
      <li>Add filter bar</li>
      <li>Start adding maps api. Secure your API key!</li>
      <li>Change search icon color. Also make it actually stay in its place when resizing. Also reposition it to fit snugly between Google's built-in map controls</li>
      <li>Add media queries!!</li>
    </ol>
  </div>
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  <script>
    let locs = [
      {
        title: "Untitled (Lamp/Bear)", 
        artists: "Urs Fischer",
        description: `2005-06. Painted and lacquered cast bronze, acrylic glass, LED lights, stainless steel` + ` 
        interior framework. 23' x 21'4" x 24'7". Lent from the Steven and Alexandra Cohen Collection. ` + 
        `Installed on Simmons Quad near Ashamu Dance Studio, fall 2016`,
        location: {lat: 41.8265259, lng: -71.4014886},
        files: ['https://i0.wp.com/blognonian.com/wp-content/uploads/2016/10/Blueno.jpg?w=412']
      }
      ];
    let infowindow = null;
    let markers = [];
    let showingTempMarker = false;
    let tempMarkerID = null;
    let map = null;

    function replaceNewline(input) {
      input = String(input);
      return input.replace(/(\r\n|\n|\r)/gm, '<br/>'); // String.fromCharCode(13, 10)
    }

    function getCarousel(loc) {
      if (!loc.files) loc.files=[];
      return `
      <div id="carousel" class="carousel slide" data-ride="carousel">
        <ol class="carousel-indicators">
          ${loc.files.map((src,idx) => 
          `<li data-target="#carousel" data-slide-to="${idx}" ${(idx==0)?"class='active'":""}></li>`)}
        </ol>
        <div class="carousel-inner">
          ${loc.files.map((src,idx) => 
            `<div class="carousel-item ${(idx==0)?"active":""}">
              <img class="size-img" src=${src}>
            </div>`
            )}
        </div>
        <a class="carousel-control-prev" href="#carousel" role="button" data-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carousel" role="button" data-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
      </div>
      `;
    }

    function locationWindow(idx) {
      let loc = locs[idx];
      let carousel = getCarousel(loc);
      return `<div>
            ${carousel}
            <h1 class="title">${loc.title}</h1>
            <div>
              <p class="artist">Artist(s): ${loc.artists}</p>
              <p class="desc">${replaceNewline(loc.description)}</p>
            </div>
            <button type="button" onclick="editWindow(${idx})">Edit</button>
          </div>`;
    }

    function editWindow(idx) {
      let loc = locs[idx];
      let carousel = getCarousel(loc);
      let content = `<div>
            ${carousel}
            <button type="button">Upload</button>
            <form method="POST" action="/landmarks/${loc.id} id="editForm">
              <label for="formTitle">Title:</label><br>
              <input type="text" id="formTitle" name="formTitle" value="${loc.title}"><br>
              <label for="formArtist">Artist(s):</label><br>
              <input type="text" id="formArtist" name="formArtist" value="${loc.artists}"><br>
              <label for="formDescription">Description:</label><br>
              <textarea name="formDescription" id="formDescription" style="width:562px;height:100px;">${loc.description}</textarea><br>
              <button type="button">Cancel</button>
              <button type="button" onclick="onDelete(${idx})">Delete</button>
              <button type="button" onclick="onEdit(${idx})">Save</button>
            </form>
          </div>`;
      infowindow.setContent(content);
      infowindow.open(map, markers[idx]);
    }

    function onDelete(idx) {
      let r = confirm("Are you sure you want to delete this landmark? The action can't be undone.");
      if(!r){
        return;
      }
      let loc = locs[idx];
      removeMarker(idx);
      console.log("requesting to delete: " + loc.id);
      fetch(`/landmarks/${loc.id}`, {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          console.log("got something back from delete!");}) // check if good response I guess?
    }

    function onEdit(idx) {
      // ftitle, artist, description
      // TODO upload (files)
      // TODO allow people to move markers? show current location w/ lng/lat?
      const loc = locs[idx];
      let message = {
        'title': document.getElementById('formTitle').value,
        'artists': document.getElementById('formArtist').value,
        'description': document.getElementById('formDescription').value
      }
      console.log("requesting edit");
      console.log(message);
      locs[idx].title = message.title;
      locs[idx].artists = message.artists;
      locs[idx].description = message.description;
      markers[idx].setTitle(message.title); // might need to refresh
      fetch(`/landmarks/${loc.id}`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(message),
      })
        .then(response => response.json())
        .then(data => {
          console.log("got data back from edit!");
        })
    }

    function createWindow(idx) {
      showingTempMarker= false;
      locs[idx] = {title: "", artist: "", description: "", files: []};
      loc = locs[idx];
      let carousel = getCarousel(loc);
      let content = `<div>
            ${carousel}
            <button type="button">Upload</button>
            <form>
              <label for="cFormTitle">Title:</label><br>
              <input type="text" id="cFormTitle" name="cFormTitle" value="${loc.title}"><br>
              <label for="cFormArtist">Artist:</label><br>
              <input type="text" id="cFormArtist" name="cFormArtist" value="${loc.artist}"><br>
              <label for="cFormDescription">Description:</label><br>
              <textarea name="cFormDescription" id="cFormDescription" style="width:562px;height:100px;">${loc.description}</textarea><br>
              <button type="button" onclick="removeMarker(${idx})">Cancel</button>
              <button type="button" onclick="onCreate(${idx})">Save</button>
            </form>
          </div>`;
      infowindow.setContent(content);
      infowindow.open(map, markers[idx]);
    }

    function onCreate(idx) {

      // ftitle, artist, description
      // TODO upload (files)
      // location ({lat, lng})
      console.log(document.getElementById('cFormTitle').value);
      console.log(document.getElementById('cFormArtist').value);
      console.log(document.getElementById('cFormDescription').value);
      let message = {
        'title': document.getElementById('cFormTitle').value,
        'artists': document.getElementById('cFormArtist').value,
        'description': document.getElementById('cFormDescription').value,
        'location': {
          'lat': markers[idx].getPosition().lat(),
          'lng': markers[idx].getPosition().lng() // unclear if these are strings or what
        },
        'files': []
      }

      // update local storage
      locs[idx].title = message.title;
      locs[idx].artists = message.artists;
      locs[idx].description = message.description;
      locs[idx].location = message.location;
      locs[idx].files = message.files;

      // create non-temporary marker to handle click events
      let marker = new google.maps.Marker({
        position: markers[idx].getPosition(), 
        title: message.title, 
        map: map
      });
      marker.addListener('click', function() {
        infowindow.setContent(locationWindow(idx));
        infowindow.open(map, marker);
      });
      removeMarker(idx);
      markers[idx] = marker;

      console.log("requesting create");
      console.log(message);
      fetch(`/landmarks`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(message),
      })
        .then(response => response.json())
        .then(data => {
          console.log("got an id back from create! id:" + data.id);
          locs[idx].id = data.id;
        })
    }

    function placeMarker(location) {
          let marker = new google.maps.Marker({
              position: location, 
              map: map
          });
          markers.push(marker);
    }

    function removeMarker(idx) {
      markers[idx].setMap(null); // maybe should actually remove but yay indexing
      console.log("removed marker");
    }

    function getLocs() {
      fetch('/landmarks')
        .then(response => response.json())
        .then(data => {
          console.log(data)
          locs = data;
          markers = locs.map((loc,idx) => {
            let marker = new google.maps.Marker({
              position: loc.location, 
              title: loc.title,
              map: map});
            marker.addListener('click', function() {
              infowindow.setContent(locationWindow(idx));
              infowindow.open(map, marker);
            });
            return marker;
          })
        });
    }

    function initMap() {
      var providence = {lat: 41.826, lng: -71.404};
      map = new google.maps.Map(
          document.getElementById('map'), {
            zoom: 16,
            center: providence,
            styles: [
           {
            featureType: 'poi.business',
            stylers: [{visibility: 'off'}]
           },
          ]
        });
      infowindow = new google.maps.InfoWindow();
        // center the view
      var marker = new google.maps.Marker({position: providence, map: map});
      marker.setVisible(false);
      
      // load current landmarks
      getLocs();
      
      // set up click to create
      google.maps.event.addListener(map, 'click', function(event) {
        if(showingTempMarker){
          removeMarker(tempMarkerID);
        }
        idx = markers.length;
        placeMarker(event.latLng);
        showingTempMarker = true;
        tempMarkerID = idx;
        let content = `
      <button type="button" onclick="removeMarker(${idx})">Remove</button>
      `;
        markers[idx].addListener('click', function() {
          infowindow.setContent(content);
          infowindow.open(map, this);
        });
        infowindow.setContent(`
      <button type="button" onclick="createWindow(${idx})">Add New</button>
      `);
        infowindow.open(map, markers[idx]);
      });
      // workaround for cleaning up old markers when clicking elsewhere
      setInterval(function (){
        if(!infowindow.getMap() && showingTempMarker){
          removeMarker(tempMarkerID);
          showingTempMarker = false;
        }
      }, 1000);
    }
        </script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZGW91AQxQ1YwcHpm44mkSBFNr6xoj4NU&callback=initMap">
  </script>
</body>
</html>